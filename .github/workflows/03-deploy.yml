name: Deploy (Production)
on:
  push:
    branches: [main]
    paths:
      - 'Dockerfile'
      - '.github/workflows/**'
      - 'cmd/**'
      - 'internal/**'
      - 'go.*'
      - 'fly.toml'
concurrency:
  group: deploy-prod
  cancel-in-progress: true
permissions:
  contents: read
  packages: write
jobs:
  build:
    uses: ./.github/workflows/02-build-image.yml
    with:
      push: true
      platforms: linux/amd64

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Set up flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1
        with:
          version: 0.3.180
      - name: Verify flyctl
        run: |
          flyctl version
          flyctl status || true  # optional quick smoke
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      - name: Deploy
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          # Use the pre-built image from GHCR instead of rebuilding
          flyctl deploy --remote-only --strategy immediate --image ghcr.io/${{ github.repository }}:main
      - name: Verify health
        run: |
          flyctl checks list --json | jq -e '.[] | select(.Status!="passing")' && exit 1 || echo OK
